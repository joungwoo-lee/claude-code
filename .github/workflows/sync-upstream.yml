name: Sync Upstream

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/anthropics/claude-code.git || true
          git remote -v

      - name: Fetch upstream
        run: |
          git fetch upstream --all

      - name: Sync main branch
        run: |
          git checkout main
          git merge upstream/main --allow-unrelated-histories --no-edit || {
            echo "Merge conflict detected or upstream branch doesn't exist"
            exit 0
          }

      - name: Push changes
        run: |
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync other branches
        if: failure() != true
        run: |
          for branch in $(git branch -r | grep upstream/ | grep -v HEAD); do
            LOCAL_BRANCH="${branch#upstream/}"
            if [ "$LOCAL_BRANCH" != "main" ]; then
              git checkout -b "$LOCAL_BRANCH" "upstream/$LOCAL_BRANCH" 2>/dev/null || true
              git push origin "$LOCAL_BRANCH" 2>/dev/null || true
            fi
          done
